{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha Clínica Básica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
  <div class="container my-5">
    <div class="card shadow-sm main-card">
      <div class="card-header bg-white border-0 py-4">
        <h1>Ficha Clínica Básica</h1>
        {% if paciente %}
          <p class="mb-0">Paciente: {{ paciente.nombre }}</p>
        {% else %}
          <p class="mb-0">Busque un paciente por RUT</p>
        {% endif %}
      </div>
      <div class="card-body p-4">
        {% if not paciente %}
          <div class="mb-4">
            <label for="paciente-rut" class="form-label">RUT del Paciente</label>
            <input 
              type="text" 
              id="paciente-rut" 
              class="form-control" 
              placeholder="Ej: 12345678-9" 
              autocomplete="off">
            <div id="resultados-busqueda" class="list-group mt-2" style="display: none; position: absolute; z-index: 1000; max-height: 300px; overflow-y: auto; width: calc(100% - 2rem);"></div>
            <small class="form-text text-muted">Ingrese el RUT del paciente para buscarlo</small>
          </div>
          
          {% if error %}
            <div class="alert alert-danger" role="alert">
              {{ error }}
            </div>
          {% endif %}
        {% endif %}
        
        {% if paciente %}
          <dl class="row">
            <dt class="col-sm-3">RUT</dt>
            <dd class="col-sm-9">{{ paciente.rut }}</dd>
            
            <dt class="col-sm-3">Nombre</dt>
            <dd class="col-sm-9">{{ paciente.nombre }}</dd>
            
            <dt class="col-sm-3">Edad</dt>
            <dd class="col-sm-9">{{ paciente.edad|default:"No registrada" }}</dd>
            
            <dt class="col-sm-3">Género</dt>
            <dd class="col-sm-9">{{ paciente.genero|default:"No registrado" }}</dd>
            
            <dt class="col-sm-3">Previsión</dt>
            <dd class="col-sm-9">{{ paciente.prevision|default:"No registrada" }}</dd>
            
            {% if ficha %}
              <dt class="col-sm-3">Comorbilidades</dt>
              <dd class="col-sm-9">{{ ficha.comorbilidades|default:"Ninguna registrada" }}</dd>
              
              <dt class="col-sm-3">Funcionalidad</dt>
              <dd class="col-sm-9">{{ ficha.funcionalidad|default:"No registrada" }}</dd>
              
              <dt class="col-sm-3">Observaciones</dt>
              <dd class="col-sm-9">{{ ficha.observaciones|default:"Sin observaciones" }}</dd>
            {% else %}
              <dt class="col-sm-3">Ficha Clínica</dt>
              <dd class="col-sm-9"><em class="text-muted">No hay ficha clínica registrada para este paciente</em></dd>
            {% endif %}
          </dl>
          
          <div class="mt-4">
            <a href="{% url 'medico_historial' paciente.rut %}" class="btn btn-outline-secondary">Ver Historial de Derivaciones</a>
            <a href="{% url 'medico_actual' paciente.rut %}" class="btn btn-outline-info">Ver Derivación Actual</a>
          </div>
        {% endif %}
        
        <a href="{% url 'medico' %}" class="d-block text-center mt-4">Volver al Menú Médico</a>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const inputRut = document.getElementById('paciente-rut');
    
    if (inputRut) {
      const resultadosBusqueda = document.getElementById('resultados-busqueda');
      let timeoutId;

      inputRut.addEventListener('input', function() {
        const rut = this.value.trim();
        
        clearTimeout(timeoutId);
        
        if (rut.length < 2) {
          resultadosBusqueda.style.display = 'none';
          return;
        }
        
        timeoutId = setTimeout(() => {
          buscarPaciente(rut);
        }, 300);
      });

      function buscarPaciente(rut) {
        fetch(`/api/buscar-paciente/?rut=${encodeURIComponent(rut)}`)
          .then(response => response.json())
          .then(data => {
            mostrarResultados(data.pacientes);
          })
          .catch(error => {
            console.error('Error al buscar paciente:', error);
          });
      }

      function mostrarResultados(pacientes) {
        resultadosBusqueda.innerHTML = '';
        
        if (pacientes.length === 0) {
          resultadosBusqueda.innerHTML = '<div class="list-group-item text-muted">No se encontraron pacientes</div>';
          resultadosBusqueda.style.display = 'block';
          return;
        }
        
        pacientes.forEach(paciente => {
          const item = document.createElement('a');
          item.href = `/medico/ficha/${paciente.rut}/`;
          item.className = 'list-group-item list-group-item-action';
          item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${paciente.nombre}</h6>
              <small>${paciente.rut}</small>
            </div>
            <small class="text-muted">Edad: ${paciente.edad || 'N/A'} | Previsión: ${paciente.prevision || 'N/A'}</small>
          `;
          
          resultadosBusqueda.appendChild(item);
        });
        
        resultadosBusqueda.style.display = 'block';
      }

      // Cerrar resultados al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!inputRut.contains(e.target) && !resultadosBusqueda.contains(e.target)) {
          resultadosBusqueda.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
